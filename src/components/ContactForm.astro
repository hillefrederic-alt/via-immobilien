---
/**
 * ContactForm - Contact form with validation, honeypot, and GDPR consent
 *
 * Features:
 * - Cloudflare Worker backend for form submission
 * - Blur-based inline validation
 * - Honeypot spam protection
 * - GDPR-compliant consent checkbox
 * - Full accessibility (ARIA attributes)
 * - Loading state and error handling
 *
 * @example
 * <ContactForm />
 */

interface Props {
  /** Worker URL - defaults to production, override for local dev */
  workerUrl?: string;
  /** Turnstile Site Key */
  turnstileSiteKey?: string;
}

const {
  workerUrl = 'https://via-immobilien-kontakt.fh-45a.workers.dev',
  turnstileSiteKey = '0x4AAAAAACXNilj8UVTKxnsu'
} = Astro.props;
---

<!-- Cloudflare Turnstile Script -->
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<form
  id="contact-form"
  class="contact-form"
  novalidate
  data-worker-url={workerUrl}
  data-turnstile-key={turnstileSiteKey}
>
  <!-- Honeypot field (hidden from users, catches bots) -->
  <input
    type="text"
    name="contact_number"
    class="honeypot"
    aria-hidden="true"
    tabindex="-1"
    autocomplete="off"
  />

  <!-- Name field -->
  <div class="form-field">
    <label for="name">Name *</label>
    <input
      type="text"
      id="name"
      name="name"
      required
      minlength="2"
      placeholder=" "
      aria-describedby="name-error"
    />
    <span id="name-error" class="error-message" aria-live="polite">
      Bitte geben Sie Ihren Namen ein.
    </span>
  </div>

  <!-- Email field -->
  <div class="form-field">
    <label for="email">E-Mail *</label>
    <input
      type="email"
      id="email"
      name="email"
      required
      placeholder=" "
      aria-describedby="email-error"
    />
    <span id="email-error" class="error-message" aria-live="polite">
      Bitte geben Sie eine gültige E-Mail-Adresse ein.
    </span>
  </div>

  <!-- Phone field (optional) -->
  <div class="form-field">
    <label for="phone">Telefon (optional)</label>
    <input
      type="tel"
      id="phone"
      name="phone"
      placeholder="+49"
      aria-describedby="phone-error"
    />
  </div>

  <!-- Message field -->
  <div class="form-field">
    <label for="message">Nachricht *</label>
    <textarea
      id="message"
      name="message"
      rows="5"
      required
      minlength="10"
      placeholder=" "
      aria-describedby="message-error"
    ></textarea>
    <span id="message-error" class="error-message" aria-live="polite">
      Bitte geben Sie eine Nachricht ein (mindestens 10 Zeichen).
    </span>
  </div>

  <!-- GDPR consent checkbox -->
  <div class="form-field checkbox-field">
    <input
      type="checkbox"
      id="consent"
      name="consent"
      required
      aria-describedby="consent-error"
    />
    <label for="consent">
      Ich stimme der <a href="/datenschutz" target="_blank" rel="noopener noreferrer">Datenschutzerklärung</a> zu und willige ein, dass meine Daten zur Bearbeitung meiner Anfrage verarbeitet werden. *
    </label>
    <span id="consent-error" class="error-message" aria-live="polite">
      Bitte stimmen Sie der Datenschutzerklärung zu.
    </span>
  </div>

  <!-- Cloudflare Turnstile Widget -->
  <div class="form-field turnstile-field">
    <div
      class="cf-turnstile"
      data-sitekey={turnstileSiteKey}
      data-theme="light"
      data-language="de"
    ></div>
    <span id="turnstile-error" class="error-message" aria-live="polite">
      Bitte bestätigen Sie, dass Sie kein Roboter sind.
    </span>
  </div>

  <!-- Status message -->
  <div id="form-status" class="form-status" role="alert" aria-live="polite"></div>

  <!-- Submit button -->
  <button type="submit" class="submit-button">
    <span class="button-text">Nachricht senden</span>
    <span class="button-loading">Wird gesendet...</span>
  </button>
</form>

<style>
  /* ---- Form Layout ---- */
  .contact-form {
    max-width: 600px;
  }

  .form-field {
    margin-bottom: var(--spacing-lg);
  }

  /* ---- Labels ---- */
  label {
    display: block;
    font-weight: var(--font-weight-semibold);
    color: var(--color-navy);
    margin-bottom: var(--spacing-xs);
  }

  /* ---- Input and Textarea Base Styles ---- */
  input[type="text"],
  input[type="email"],
  input[type="tel"],
  textarea {
    width: 100%;
    padding: var(--spacing-sm);
    border: 2px solid var(--color-border);
    border-radius: var(--border-radius-sm);
    transition: border-color var(--transition-normal), outline var(--transition-fast);
    font-family: var(--font-sans);
    font-size: var(--font-size-base);
    color: var(--color-text);
    background-color: var(--color-white);
  }

  textarea {
    resize: vertical;
    min-height: 120px;
  }

  /* ---- Focus State (WCAG 2.2 compliant) ---- */
  input[type="text"]:focus,
  input[type="email"]:focus,
  input[type="tel"]:focus,
  textarea:focus {
    outline: 3px solid var(--color-gold);
    outline-offset: 2px;
    border-color: var(--color-navy);
  }

  /* ---- Invalid State (blur + has content) ---- */
  input[type="text"]:not(:focus):not(:placeholder-shown):invalid,
  input[type="email"]:not(:focus):not(:placeholder-shown):invalid,
  input[type="tel"]:not(:focus):not(:placeholder-shown):invalid,
  textarea:not(:focus):not(:placeholder-shown):invalid {
    border-color: #C1292E;
    outline: 2px solid #C1292E;
  }

  /* ---- Valid State (optional positive feedback) ---- */
  input[type="text"]:not(:focus):not(:placeholder-shown):valid,
  input[type="email"]:not(:focus):not(:placeholder-shown):valid,
  input[type="tel"]:not(:focus):not(:placeholder-shown):valid,
  textarea:not(:focus):not(:placeholder-shown):valid {
    border-color: #2E7D32;
  }

  /* ---- Error Messages ---- */
  .error-message {
    display: none;
    color: #C1292E;
    font-size: var(--font-size-sm);
    margin-top: var(--spacing-xs);
  }

  /* Show error message when input is invalid */
  input:not(:focus):not(:placeholder-shown):invalid + .error-message,
  textarea:not(:focus):not(:placeholder-shown):invalid + .error-message {
    display: block;
  }

  /* Special handling for checkbox error */
  input[type="checkbox"]:invalid:not(:focus) ~ .error-message {
    display: block;
  }

  /* Hide checkbox error when valid */
  input[type="checkbox"]:valid ~ .error-message {
    display: none;
  }

  /* ---- Honeypot Field (Hidden) ---- */
  .honeypot {
    position: absolute;
    left: -9999px;
    width: 1px;
    height: 1px;
  }

  /* ---- Checkbox Field Layout ---- */
  .checkbox-field {
    display: flex;
    flex-wrap: wrap;
    align-items: flex-start;
    gap: var(--spacing-sm);
  }

  .checkbox-field input[type="checkbox"] {
    width: auto;
    margin-top: 0.25rem;
    cursor: pointer;
    flex-shrink: 0;
  }

  .checkbox-field label {
    flex: 1;
    font-weight: var(--font-weight-normal);
    margin-bottom: 0;
    cursor: pointer;
  }

  .checkbox-field label a {
    color: var(--color-navy);
    text-decoration: underline;
  }

  .checkbox-field label a:hover,
  .checkbox-field label a:focus {
    color: var(--color-gold);
  }

  .checkbox-field .error-message {
    flex-basis: 100%;
    margin-top: 0;
  }

  /* ---- Turnstile Widget ---- */
  .turnstile-field {
    margin-bottom: var(--spacing-lg);
  }

  .turnstile-field .error-message {
    margin-top: var(--spacing-sm);
  }

  /* ---- Form Status ---- */
  .form-status {
    padding: var(--spacing-md);
    border-radius: var(--border-radius-sm);
    margin-bottom: var(--spacing-md);
    display: none;
  }

  .form-status.success {
    display: block;
    background-color: #E8F5E9;
    color: #2E7D32;
    border: 1px solid #2E7D32;
  }

  .form-status.error {
    display: block;
    background-color: #FFEBEE;
    color: #C1292E;
    border: 1px solid #C1292E;
  }

  /* ---- Submit Button ---- */
  .submit-button {
    background-color: var(--color-gold);
    color: var(--color-navy);
    padding: var(--spacing-md) var(--spacing-xl);
    border: none;
    border-radius: var(--border-radius-md);
    font-weight: var(--font-weight-semibold);
    font-size: var(--font-size-base);
    cursor: pointer;
    transition: all var(--transition-normal);
    width: 100%;
  }

  .submit-button:hover,
  .submit-button:focus {
    background-color: var(--color-navy);
    color: var(--color-cream);
    outline: 3px solid var(--color-gold);
    outline-offset: 2px;
  }

  .submit-button:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }

  .submit-button .button-loading {
    display: none;
  }

  .submit-button.loading .button-text {
    display: none;
  }

  .submit-button.loading .button-loading {
    display: inline;
  }

  /* ---- Responsive Adjustments ---- */
  @media (min-width: 640px) {
    .submit-button {
      width: auto;
    }
  }
</style>

<script>
  const form = document.getElementById('contact-form') as HTMLFormElement;
  const submitButton = form?.querySelector('.submit-button') as HTMLButtonElement;
  const statusDiv = document.getElementById('form-status') as HTMLDivElement;
  const turnstileError = document.getElementById('turnstile-error') as HTMLSpanElement;
  const workerUrl = form?.dataset.workerUrl || '';

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Reset status
    statusDiv.className = 'form-status';
    statusDiv.textContent = '';
    turnstileError.style.display = 'none';

    // Check form validity
    if (!form.checkValidity()) {
      form.reportValidity();
      return;
    }

    // Get Turnstile response
    const turnstileResponse = (window as any).turnstile?.getResponse();
    if (!turnstileResponse) {
      turnstileError.style.display = 'block';
      return;
    }

    // Show loading state
    submitButton.disabled = true;
    submitButton.classList.add('loading');

    try {
      // Gather form data
      const formData = new FormData(form);
      const data = {
        name: formData.get('name'),
        email: formData.get('email'),
        phone: formData.get('phone') || undefined,
        message: formData.get('message'),
        consent: formData.get('consent') ? 'on' : '',
        contact_number: formData.get('contact_number') || undefined,
        'cf-turnstile-response': turnstileResponse,
      };

      // Send to Worker
      const response = await fetch(workerUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });

      const result = await response.json();

      if (response.ok && result.success) {
        // Success - redirect to thank you page
        window.location.href = '/danke';
      } else {
        // Show error
        statusDiv.className = 'form-status error';
        statusDiv.textContent = result.error || 'Ein Fehler ist aufgetreten. Bitte versuchen Sie es erneut.';
        if (result.details) {
          statusDiv.textContent += ' ' + result.details.join(', ');
        }
        // Reset Turnstile on error
        (window as any).turnstile?.reset();
      }
    } catch (error) {
      statusDiv.className = 'form-status error';
      statusDiv.textContent = 'Verbindungsfehler. Bitte prüfen Sie Ihre Internetverbindung.';
      // Reset Turnstile on error
      (window as any).turnstile?.reset();
    } finally {
      submitButton.disabled = false;
      submitButton.classList.remove('loading');
    }
  });
</script>
