---
/**
 * Header - Smart sticky header with navigation and mobile hamburger menu
 *
 * Features:
 * - Smart sticky: hides on scroll down, shows on scroll up
 * - Hamburger menu on mobile (<1024px) with overlay
 * - Accessible: proper ARIA attributes, keyboard navigation
 * - CTA button for Kontakt stands out
 */

import Navigation from './Navigation.astro';
---

<header class="header" id="header">
  <div class="header__container container">
    <!-- Logo -->
    <a href="/" class="header__logo" aria-label="Via Immobilien - Zur Startseite">
      <span class="header__logo-text">VIA IMMOBILIEN</span>
    </a>

    <!-- Desktop Navigation -->
    <nav class="header__nav-desktop" aria-label="Hauptnavigation">
      <Navigation variant="desktop" />
    </nav>

    <!-- Mobile Menu Button -->
    <button
      type="button"
      class="header__menu-btn"
      id="menu-toggle"
      aria-expanded="false"
      aria-controls="mobile-menu"
      aria-label="Menu offnen"
    >
      <span class="header__menu-icon" aria-hidden="true">
        <span class="header__menu-bar"></span>
        <span class="header__menu-bar"></span>
        <span class="header__menu-bar"></span>
      </span>
      <span class="header__menu-text">Menu</span>
    </button>
  </div>

  <!-- Mobile Navigation Overlay -->
  <div class="header__mobile-overlay" id="mobile-menu" aria-hidden="true">
    <nav class="header__nav-mobile" aria-label="Mobile Navigation">
      <Navigation variant="mobile" />
    </nav>
  </div>
</header>

<style>
  .header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
    background-color: var(--color-cream);
    border-bottom: 1px solid var(--color-border);
    transition: transform var(--transition-normal);
  }

  .header--hidden {
    transform: translateY(-100%);
  }

  .header__container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 4.5rem; /* 72px */
  }

  /* Logo */
  .header__logo {
    display: flex;
    align-items: center;
    text-decoration: none;
    color: var(--color-navy);
  }

  .header__logo-text {
    font-family: var(--font-serif);
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-normal);
    letter-spacing: 0.1em;
    color: var(--color-navy);
  }

  .header__logo:hover .header__logo-text,
  .header__logo:focus .header__logo-text {
    color: var(--color-gold);
  }

  /* Desktop Navigation */
  .header__nav-desktop {
    display: none;
  }

  @media (min-width: 1024px) {
    .header__nav-desktop {
      display: block;
    }
  }

  /* Mobile Menu Button */
  .header__menu-btn {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-sm) var(--spacing-md);
    background: transparent;
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius-md);
    cursor: pointer;
    color: var(--color-navy);
    transition: background-color var(--transition-fast), border-color var(--transition-fast);
  }

  .header__menu-btn:hover,
  .header__menu-btn:focus {
    background-color: rgba(20, 35, 51, 0.05);
    border-color: var(--color-navy);
  }

  @media (min-width: 1024px) {
    .header__menu-btn {
      display: none;
    }
  }

  .header__menu-icon {
    display: flex;
    flex-direction: column;
    justify-content: center;
    width: 1.25rem;
    height: 1rem;
    gap: 3px;
  }

  .header__menu-bar {
    display: block;
    width: 100%;
    height: 2px;
    background-color: var(--color-navy);
    transition: transform var(--transition-fast), opacity var(--transition-fast);
  }

  /* Hamburger to X animation when open */
  .header__menu-btn[aria-expanded="true"] .header__menu-bar:nth-child(1) {
    transform: rotate(45deg) translate(4px, 4px);
  }

  .header__menu-btn[aria-expanded="true"] .header__menu-bar:nth-child(2) {
    opacity: 0;
  }

  .header__menu-btn[aria-expanded="true"] .header__menu-bar:nth-child(3) {
    transform: rotate(-45deg) translate(4px, -4px);
  }

  .header__menu-text {
    font-family: var(--font-sans);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* Mobile Overlay */
  .header__mobile-overlay {
    position: fixed;
    top: 4.5rem;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--color-navy);
    opacity: 0;
    visibility: hidden;
    transition: opacity var(--transition-normal), visibility var(--transition-normal);
    overflow-y: auto;
    z-index: 99;
  }

  .header__mobile-overlay[aria-hidden="false"] {
    opacity: 1;
    visibility: visible;
  }

  .header__nav-mobile {
    padding: var(--spacing-xl) var(--spacing-md);
  }

  @media (min-width: 1024px) {
    .header__mobile-overlay {
      display: none;
    }
  }

  /* Prevent body scroll when menu is open */
  :global(body.menu-open) {
    overflow: hidden;
  }
</style>

<script>
  // Smart sticky header behavior
  const header = document.getElementById('header') as HTMLElement;
  const menuToggle = document.getElementById('menu-toggle') as HTMLButtonElement;
  const mobileMenu = document.getElementById('mobile-menu') as HTMLElement;

  let lastScrollY = 0;
  let isMenuOpen = false;
  const scrollThreshold = 100;

  // Smart sticky: hide on scroll down, show on scroll up
  function handleScroll() {
    const currentScrollY = window.scrollY;

    // Don't hide header if menu is open
    if (isMenuOpen) {
      return;
    }

    if (currentScrollY > scrollThreshold) {
      if (currentScrollY > lastScrollY) {
        // Scrolling down
        header.classList.add('header--hidden');
      } else {
        // Scrolling up
        header.classList.remove('header--hidden');
      }
    } else {
      // At top of page
      header.classList.remove('header--hidden');
    }

    lastScrollY = currentScrollY;
  }

  // Mobile menu toggle
  function toggleMenu() {
    isMenuOpen = !isMenuOpen;

    menuToggle.setAttribute('aria-expanded', String(isMenuOpen));
    menuToggle.setAttribute('aria-label', isMenuOpen ? 'Menu schliessen' : 'Menu offnen');
    mobileMenu.setAttribute('aria-hidden', String(!isMenuOpen));
    document.body.classList.toggle('menu-open', isMenuOpen);

    // Show header when menu opens
    if (isMenuOpen) {
      header.classList.remove('header--hidden');
    }
  }

  function closeMenu() {
    if (isMenuOpen) {
      isMenuOpen = false;
      menuToggle.setAttribute('aria-expanded', 'false');
      menuToggle.setAttribute('aria-label', 'Menu offnen');
      mobileMenu.setAttribute('aria-hidden', 'true');
      document.body.classList.remove('menu-open');
    }
  }

  // Event listeners
  window.addEventListener('scroll', handleScroll, { passive: true });

  menuToggle.addEventListener('click', toggleMenu);

  // Close menu on Escape key
  document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape') {
      closeMenu();
    }
  });

  // Close menu when clicking a link in mobile menu
  mobileMenu.querySelectorAll('a').forEach((link) => {
    link.addEventListener('click', closeMenu);
  });

  // Close menu when resizing to desktop
  window.addEventListener('resize', () => {
    if (window.innerWidth >= 1024) {
      closeMenu();
    }
  });
</script>
